<!--备案管理  -->
<style type="text/css">
	.left{
		border-left: 1px solid #ccc;
		border-right: 1px solid #ccc;
		height: 700px;
	}
	.border{
		height: 100px;
		margin-left: 20px;
		border-bottom: 1px solid #ccc;
	}
	#chosen{
		/* background: none;
		border:none;
		outline: none; */
	}
	#chosen_gridBox,#chakan_gridBox{
		 display: none; 
	}
	.ui-jqgrid  {
		width: 1000px;
	}
	.qingdan,.qingdan2{
		border: 1px solid #000;
	}
	.qingdan{
		border-bottom: none;
	}
	.qingdan span,.qingdan2 span{
		display: block;
		margin-top: 5px;
	}
	.ctro span{
		display: block;
		vertical-align:middle !important; 
		text-align: right;
		margin-top: 30px;
	}
	.chakan {
		color: #49dacb;
		text-align: left;
	}
	#chakan_gridBox{
		overflow: hidden;
	}
	.text-left{
		text-align: left !important;
	}
</style>
<div class="container-fluid">
	<div class="col-sm-12 plr0 height100 gridBox" id="beian_gridBox">
		<table id="beian_jqGrid"></table>
		<div id="beian_jqGridPager"></div>
	</div>
	<div class="col-sm-12 plr0 height100 gridBox" id="chosen_gridBox">
		<table id="chosen_jqGrid"></table>
		<div id="chosen_jqGridPager"></div>
		<div class="col-sm-12 text-center">
			<button class="qx btn btn-info" type="button">确定</button>
			<button class="qx btn btn-info" type="button">取消</button>
		</div>
	</div>
	<div class="col-sm-12 plr0 height100 gridBox" id="chakan_gridBox">
		<table id="chakan_jqGrid"></table>
		<div class="col-sm-12 text-center">
			<button class="qx btn btn-info" type="button">确定</button>
			<button class="qx btn btn-info" type="button">取消</button>
		</div>
	</div>
</div>

<!-- 新增弹窗 -->
<div id="beian_formBox" class="layerFormBox">
	<form class="form-horizontal layerForm">
		<div class="form-group col-xs-3 left">
			<div class="col-xs-12">
				<span class="col-sm-12">申报批次20170301</span>
				<div class="col-sm-12">
					<table class="table table-bordered"> 
						<thead>
							<tr>
								<th></th>
								<th>关联号</th>
								<th>关单号</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><input type="radio" name=""></td>
								<td>FOB</td>
								<td>对外出口</td>
							</tr>
							<tr>
								<td><input type="radio" name=""></td>
								<td>CFI</td>
								<td>一般贸易</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="form-group col-xs-9 right">
			<div class="col-sm-12 border">
				<div class="form-group col-sm-6">
					<label class="col-sm-6 control-label text-right">所属期:</label>
					<div class="col-sm-6">
						<input type="text" class="form-control input-sm" placeholder="所属期" id="beian_mydata" name="mydata">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-sm-6 control-label text-right">关联号:</label>
					<div class="col-sm-6">
						<input type="text" class="form-control input-sm" id="beian_relName" name="relName" placeholder="关联号" value="59b5e9a8dc254b4cd74a49f2">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-sm-6 control-label text-right">关单号:</label>
					<div class="col-sm-6">
						<input type="text" class="form-control input-sm" id="beian_guandan" name="guandan" placeholder="关单号">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-sm-6 control-label text-right">退税申报日期:</label>
					<div class="col-sm-6">
						<input type="text" class="form-control input-sm" id="beian_createTime" name="createTime" placeholder="退税申报日期" value="59b5e9a8dc254b4cd74a49f2">
					</div>
				</div>
				<div class="form-group col-sm-3">
					<div class="col-sm-10">
						<button class="btn btn-info" id="chosen" type="button">选择采购合同</button>
					</div>
				</div>
				<div class="qingdan col-sm-12">
					<p class="col-sm-6">
						<span>购货合同:购货合同1原件.pdf</span>
						<span>出口装箱单:装箱单元件1.jpg</span>
						<span>出口运输单:运单原件1.pdf</span>
					</p>
					<p class="ctro col-sm-6">
						<span>删除</span>
					</p>
				</div>
				<div class="qingdan2 col-sm-12">
					<p class="col-sm-6">
						<span>购货合同:购货合同2原件.pdf</span>
						<span>出口装箱单:装箱单元件2.jpg</span>
						<span>出口运输单:运单原件2.pdf</span>
					</p>
					<p class="ctro col-sm-6">
						<span>删除</span>
					</p>
				</div>
				<div class="form-group col-sm-12">
					<span class="col-sm-3">出口发票号：21213131</span>
				</div>
				<div class="form-group col-sm-12">
					<span class="col-sm-3">出口货物明细：</span>
					<span class="col-sm-1 chakan" id="chakan">查看</span>
				</div>
				<div class="form-group col-sm-12">
					<label class="col-xs-2 control-label text-left">
						其他单证:
					</label>
					<div class="col-xs-3 text-left">
						<input type="text" class="form-control input-sm"  placeholder="其他单证">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-xs-4 control-label text-left">
						自制出口发票:
					</label>
					<div class="col-xs-6 text-left">
						<input type="text" class="form-control input-sm"  placeholder="自制出口发票">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-xs-4 control-label text-left">
						企业办税员:
					</label>
					<div class="col-xs-6 text-left">
						<input type="text" class="form-control input-sm"  placeholder="企业办税员">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-xs-4 control-label text-left">
						备案日期:
					</label>
					<div class="col-xs-6 text-left">
						<input type="text" id="beian_anotherTime" name="anotherTime" class="form-control input-sm"  placeholder="备案日期">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-xs-4 control-label text-left">
						备案单证出处:
					</label>
					<div class="col-xs-6 text-left">
						<input type="text" id="beian_provenance" name="provenance" class="form-control input-sm"  placeholder="备案单证出处">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-xs-4 control-label text-left">
						页数:
					</label>
					<div class="col-xs-6 text-left">
						<input type="text" class="form-control input-sm"  placeholder="页数">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-xs-4 control-label text-left">
						标志:
					</label>
					<div class="col-xs-6 text-left">
						<input type="text" id="beian_sign" name="sign" class="form-control input-sm"  placeholder="标志">
					</div>
				</div>
				<div class="form-group col-sm-6">
					<label class="col-xs-4 control-label text-left">
						备注:
					</label>
					<div class="col-xs-8 text-left">
						<textarea type="text" class="form-control input-sm"  placeholder="备注"></textarea>
					</div>
				</div>
			</div>
		</div>
		<p class="text-center col-xs-12">
			<button type="button" class="saveBtn btn btn-info btn-sm" id="beian_save_btn">
				保存
			</button>
			<button type="reset" class="saveBtn btn btn-info btn-sm">
				重置
			</button>
			<button type="button" class="saveBtn btn btn-info btn-sm qx" id="beian_cacle_btn">
				取消
			</button>
		</p>
	</form>
</div>
<!-- 采购合同弹窗 -->
<div class="caigou">
	
</div>

<script type="text/javascript">

$(function(){
	var dataUrl = 'data/beian.json';
	var caigouUrl = 'data/caigou.json';
	var index = null;
	var flag = '';
	var rowNumber = 1000000;
	//表格数据
	var gridWidth = $('#beian_gridBox').width();
	var gridHeight = $('#beian_gridBox').height()-118;

	var chosen_gridWidth = $('#chosen_gridBox').width();
	var chosen_gridHeight = $('#chosen_gridBox').height()-118;
	$("#beian_jqGrid").jqGrid({
		
		hidegrid : false, 
		altRows : true, 
		colModel: [{label : '批次', name : 'pici', align: 'center', width: 120},
			{label : '关联号', name : 'relName', align: 'center', width:120},
			{label : '所属期', name : 'mydata', align: 'center', width:120},
			{label : '出口发票号', name : 'guandan', align: 'center', width:120},
			{label : '退税申报日期', name : 'createTime', align: 'center', width:120},
			{label : '备案日期', name : 'anotherTime', align: 'center', width:120},
			{label : '备案单证出处', name : 'provenance', align: 'center', width:120},
			{label : '标志', name : 'sign', align: 'center', width:120}],
		viewrecords: true,
		loadonce:true,
		width: gridWidth,
		//width: 'auto',
		//width : '100%',
		height: gridHeight,
		//height : 'auto',
		rowNum: 11,
		rowList:[10,15,20,25],
		datatype: 'local',
		pager: "#beian_jqGridPager",
		multiselect: true,
		rownumbers: true,
		rownumWidth: 30,
		recordtext: "当前显示: <b>{0}</b>至<b>{1}</b> 总数: <b>{2}</b>",
	    //emptyrecords: "No records to view",
		//loadtext: "Loading...",
		
	}).navGrid('#beian_jqGridPager',{ // the buttons to appear on the toolbar of the grid
			edit:false,add:false,del:false,search:false,refresh:false
		// }).navButtonAdd('#beian_jqGridPager',{
		// 		//caption: '生成备案',
		// 	caption: '',
		// 	title : '生成备案',
		// 	buttonicon : 'glyphicon-plus',
		// 	onClickButton : beian_addLayer, //调用添加的函数
		// 	position : 'last'
		// }).navButtonAdd('#beian_jqGridPager',{
		// 	//caption: '导入合同',
		// 	caption: '',
		// 	title : '导出备案',
		// 	buttonicon : 'fa fa-download',
		// 	onClickButton : beian_importLayer, //调用导入合同函数
		// 	position : 'last'
		}).navSeparatorAdd("#beian_jqGridPager",{
			sepcontent: '',
			sepclass : "ui-separator"
		});
		//选择
	$("#chosen_jqGrid").jqGrid({
			datatype: 'local',
			loadonce: true,
			viewrecords: true,
			multiselect: true,
			rownumbers: true,
			altRows : true,
			width: chosen_gridWidth,
			height: chosen_gridHeight,
			page : 3,
			rowNum: 10,
			colModel: [{label : '合同编号', name : 'id', align: 'center', width: 150,editable: true},
				{label : '合同名称', name : 'name', align: 'center', width:100},
				{label : '签订时间 ', name : 'qdTime', align: 'center', width:150},
				{label : '采购方', name : 'caigouName', align: 'center', width:130},
				{label : '供货方', name : 'gonghuoName', align: 'center', width:70},
				{label : '合同金额', name : 'money', align: 'center',width:80},
				{label : '物资清单', name : 'list', align: 'center',width:80},
				],
			pager: "#chosen_jqGridPager"
		})
	//查看
	var grid_data = [{
		id: "00001",
		type: "退货出库",
		pay: "1000",
		name: "abc",
		text: "ccc"
	}, {
		id: "00002",
		type: "退货出库",
		pay: "1000",
		name: "abc",
		text: "aaa"
	}, {
		id: "00003",
		type: "退货出库",
		pay: "1040.06",
		name: "abc",
		text: "ddd"
	}];
	//查看
	$("#chakan_jqGrid").jqGrid({
		data: grid_data, //当 datatype 为"local" 时需填写 
		datatype: "local", //数据来源，本地数据（local，json,jsonp,xml等）
		height: 150, //高度，表格高度。可为数值、百分比或'auto'
		colNames: ['商品编号', '名称 规格型号', '数量及单位', '单价', '总价'],
		colModel: [{
				name: 'id',
				index: 'id', 
				width: 50
			}, {
				name: 'type',
				index: 'type',
				width: 50
			}, {
				name: 'pay',
				index: 'pay',
				width: 50
			}, {
				name: 'name',
				index: 'name',
				width: 50
			}, {
				name: 'text',
				index: 'text',
				width: 50
			}],
		viewrecords: false, //是否在浏览导航栏显示记录总数
		autowidth: true
	});


	fetchGridData();
	
	haveGridData();

	//左下角新增按钮
	function beian_addLayer(){
			flag = 'add';
			$('.form-control').val('');
			index = layer.open({
				type: 1,
				title : '生成备案',
				area: ['98%', '98%'], //宽高
				content: $('#beian_formBox')
		});
	}
	//弹框保存按钮
	$(document).on('click','#beian_save_btn',function(){
		//var total = jQuery("#beian_jqGrid").jqGrid('getGridParam', 'records'); 
		////console.log(total);
		//addRowData
		//rowid,data, position, srcrowid
		//console.log(flag);
		if(flag == 'add'){
			$('#beian_name').val("20170301");
			var data = {
					"name": $.trim($('#beian_name').val()),
				    "relName": $.trim($('#beian_relName').val()),
				    "mydata": $.trim($('#beian_mydata').val()),
				    "guandan": $.trim($('#beian_guandan').val()),
				    "createTime": $.trim($('#beian_createTime').val()),
				    "anotherTime": $.trim($('#beian_anotherTime').val()),
				    "provenance": $.trim($('#beian_provenance').val()),
				    "sign": $.trim($('#beian_sign').val())
			};
			var currentNumber = rowNumber++;
			var result = jQuery("#beian_jqGrid").addRowData(currentNumber,data,'first');
			
			if(result){
				layer.msg('添加成功');
				layer.close(index);
				
				jQuery("#beian_jqGrid").setSelection(currentNumber,true);
				
			}else{
				layer.msg('添加失败!');
			}
		}else if(flag == 'update'){
			
			//删除
			var rowIds = getSelectedRow();
			jQuery("#beian_jqGrid").delRowData(rowIds[0]);
			//添加
			$('#beian_name').val("20170301");
			var data = {
					"name": $.trim($('#beian_name').val()),
				    "relName": $.trim($('#beian_relName').val()),
				    "mydata": $.trim($('#beian_mydata').val()),
				    "guandan": $.trim($('#beian_guandan').val()),
				    "createTime": $.trim($('#beian_createTime').val()),
				    "anotherTime": $.trim($('#beian_anotherTime').val()),
				    "provenance": $.trim($('#beian_provenance').val()),
				    "sign": $.trim($('#beian_sign').val())
			};
			var currentNumber = rowNumber++;
			var result = jQuery("#beian_jqGrid").addRowData(currentNumber,data,'first');
			
			if(result){
				layer.msg('更新成功');
				layer.close(index);
				jQuery("#beian_jqGrid").setSelection(currentNumber,true);
			}else{
				layer.msg('更新失败!');
			}
		}
		
	});
	// 导出函数
	function beian_importLayer(){
		var rowd = getSelectedRow();
		var len = rowd.length;
		if(rowd && $.isArray(rowd) && rowd.length>0){
			//删除
			var deletindex = layer.confirm('确定要导出吗？', {
			  btn: ['确定','取消'] //按钮
			}, function(){
				/*for(var i=0; i<len; i++){
					jQuery("#beian_jqGrid").delRowData(rowd[0]);  
				}*/
			    layer.msg('导出成功', {icon: 1});
			}, function(){
			  	layer.close(deletindex);
			});
			
		}else{
			layer.msg('请选择记录!');
		}
	}
	
	
	//弹框取消按钮
	$('.qx').on('click',function(){
		layer.close(index);
	});

	//选择采购合同
	$('#chosen').click(function(){
		index = layer.open({
				type: 1,
				title : '选择采购合同',
				area: ['90%', '90%'], //宽高
				content: $('#chosen_gridBox')
		});
	})
	// 查看
	$('#chakan').click(function(){
		index = layer.open({
				type: 1,
				area: ['70%', '70%'], //宽高
				content: $('#chakan_gridBox')
		});
	})

	//采购获取json
	function haveGridData() {

		var ArrayData = [];
		// show loading message
		$("#chosen_jqGrid")[0].grid.beginReq();
		$.ajax({
			url: caigouUrl,
			success: function(result) {
				for (var i = 0; i < result.rows.length; i++) {
					var row = result.rows[i];
					
					ArrayData.push({
						id: row.id,
						name: row.name,
						qdTime: row.qdTime,
						caigouName: row.caigouName,
						gonghuoName: row.gonghuoName,
						money: row.money,
						list: row.list
					});

				}
				// set the new data
				$("#chosen_jqGrid").jqGrid('setGridParam', {
					data: ArrayData
				});
				// hide the show message
				$("#chosen_jqGrid")[0].grid.endReq();
				// refresh the grid
				$("#chosen_jqGrid").trigger('reloadGrid');
			}
		});
	}
	
	// 获取json数据
	function fetchGridData() {

		var gridArrayData = [];
		// show loading message
		$("#beian_jqGrid")[0].grid.beginReq();
		$.ajax({
			url: dataUrl,
			success: function(result) {
				for (var i = 0; i < result.items.length; i++) {
					var item = result.items[i];
					
					gridArrayData.push({
						pici: item.pici,
						relName: item.relName,
						mydata: item.mydata,
						guandan: item.guandan,
						createTime: item.createTime,
						anotherTime: item.anotherTime,
						provenance: item.provenance,
						sign: item.sign
					});

				}
				// set the new data
				$("#beian_jqGrid").jqGrid('setGridParam', {
					data: gridArrayData
				});
				// hide the show message
				$("#beian_jqGrid")[0].grid.endReq();
				// refresh the grid
				$("#beian_jqGrid").trigger('reloadGrid');
			}
		});
	}
	//获取选择的行
	function getSelectedRow() {
	    var grid = $("#beian_jqGrid");
	    var rowKeys = grid.jqGrid('getGridParam',"selarrrow");

	   return rowKeys;
	}
	// 搜索框按钮,开启搜索框需要重新调整高度
	$('#beian_jqGrid').jqGrid('filterToolbar');
	$('#chosen_jqGrid').jqGrid('filterToolbar');
	
	
	changeSearch(); //修改工具条
	
});


	
</script>